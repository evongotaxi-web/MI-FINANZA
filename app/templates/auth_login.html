{% extends "auth_base.html" %}

{% block content %}
<form method="post" action="/login" class="form auth-form">
  <label class="label">
    <span class="muted">Correo electrónico</span>
    <div class="field">
      <span class="field-icon" data-icon="mail" aria-hidden="true"></span>
      <input class="input field-input" type="email" name="email" required autocomplete="email" placeholder="Correo electrónico" />
    </div>
  </label>
  <label class="label">
    <span class="muted">Contraseña</span>
    <div class="field">
      <span class="field-icon" data-icon="lock" aria-hidden="true"></span>
      <input id="password" class="input field-input" type="password" name="password" required autocomplete="current-password" placeholder="Contraseña" />
      <button class="field-action" type="button" onclick="const i=document.getElementById('password'); i.type = i.type === 'password' ? 'text' : 'password'">
        <span class="field-icon" data-icon="eye" aria-hidden="true"></span>
      </button>
    </div>
  </label>
  <button class="btn btn-primary btn-lg" type="submit">Iniciar Sesión</button>

  <div class="auth-links">
    <a class="link" href="/register">Crear cuenta</a>
    <span class="muted">|</span>
    <a class="link" href="/register">Recuperar contraseña</a>
  </div>

  <div class="auth-divider">
    <span class="muted">o</span>
  </div>

  {% if firebase_config_json %}
  <div id="firebaseui-auth-container"></div>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <link rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/6.0.2/firebase-ui-auth.css" />
  <script src="https://www.gstatic.com/firebasejs/ui/6.0.2/firebase-ui-auth.js"></script>
  <script>
    const firebaseConfig = {{ firebase_config_json | safe }};
    firebase.initializeApp(firebaseConfig);
    const ui = new firebaseui.auth.AuthUI(firebase.auth());
    const uiConfig = {
      callbacks: {
        signInSuccessWithAuthResult: async function(authResult) {
          const idToken = await authResult.user.getIdToken();
          const body = new URLSearchParams();
          body.set("id_token", idToken);
          const res = await fetch("/auth/firebase", {
            method: "POST",
            headers: {"Content-Type": "application/x-www-form-urlencoded"},
            credentials: "include",
            body,
          });
          const data = await res.json().catch(() => ({}));
          if (res.ok && data && data.redirect) {
            window.location.href = data.redirect;
            return false;
          }
          window.location.href = "/login?error=No%20se%20pudo%20iniciar%20sesión";
          return false;
        },
      },
      signInFlow: "popup",
      signInOptions: [
        firebase.auth.GoogleAuthProvider.PROVIDER_ID,
        firebase.auth.EmailAuthProvider.PROVIDER_ID,
        firebase.auth.PhoneAuthProvider.PROVIDER_ID,
      ],
    };
    ui.start("#firebaseui-auth-container", uiConfig);
  </script>
  {% else %}
  <a class="btn btn-social btn-lg" href="/auth/google/start">
    <span class="social-icon" data-icon="google" aria-hidden="true"></span>
    Continuar con Google
  </a>
  {% endif %}
</form>
{% endblock %}
